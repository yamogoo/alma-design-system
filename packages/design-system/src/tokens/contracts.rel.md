# Relational Color System — Usage Manifest (v1)

_Last updated: 2025-10-03_

## 0) Scope & Goal

This document defines how to **use** the relational color system in products, components, and tokens. It turns the relational color matrix into enforceable rules so that UI remains consistent, accessible, and easy to theme.

- **Single source of truth:** `contracts/rel/*` (the relational matrix).
- \*\*Consumers: component tokens.
- **Outcome:** predictable color behavior, automatic state generation, and self-documenting rules.

---

## 1) Vocabulary

**Roles** (extensible): `Neutral | Accent | Positive | Negative | Warning`

**Planes:**

- `Surface` — container/backgrounds.
- `Stroke` — borders/lines/outlines.
- `OnSurface` — graphics/icons placed on a surface (contextual).
- `Label` — text/labels (generic / more detached from specific surfaces).
- `Border` — convenience alias derived from `Stroke` for component borders/dividers.

**Tones (ladder):** `xxl-lighter, xl-lighter, lighter, base, darker, xl-darker, xxl-darker`  
(Alternatively use numeric steps; the ladder must be **monotonic**.)

**States:** `idle, hover, pressed, focus, disabled` (state values are **derived** via deltas).

---

## 2) Core Principles

1. **Matrix is law.** Components may only reference colors through the relational matrix.
2. **No cross-facet mixing.** A component cannot mix planes/roles arbitrarily. Every property must pull from its **assigned plane** and **current role**.
3. **Deterministic states.** States (`hover/pressed/disabled/focus`) are generated by formulas/deltas — not manually curated per token.
4. **Contrast first.** Foreground choices (Label/OnSurface) must satisfy WCAG contrast thresholds against their background.
5. **Contracts over hex.** Component tokens reference matrix entries; raw hex appears **only** in base palettes.

---

## 3) Contracts: Allowed Sources per Component Property

For each component property use **only** the sources listed below. Do not reference other planes/roles.

| Property     | Allowed source (path pattern)                                                                                                                                            |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `background` | `contracts/rel/surface/<role>/<tone>/<state>`                                                                                                                            |
| `border`     | `contracts/rel/stroke/<role>/<tone>/<state>` _(or `border` alias)_                                                                                                       |
| `foreground` | Prefer `contracts/rel/label/<role>/<tone>/<state>`; alternatively `contracts/rel/onSurface/<role>/<tone>/<state>` when typography is not used. Must pass contrast rules. |
| `outline`    | `contracts/rel/stroke/<role>/base/focus` or theme-specific focus ring token derived from `Stroke`.                                                                       |
| `overlay`    | `contracts/rel/surface/<role>/<tone>/<state>` with alpha per overlay rules.                                                                                              |

**Role coupling:** The role chosen by the component (e.g., `Accent.Primary`) applies **uniformly** to background/border/foreground sources. Roles must not be mixed inside a single visual entity.

---

## 4) Naming & Paths

**Relational matrix:**

```
contracts/rel/<plane>/<role>/<tone>/<state>
```

**Component tokens map** to `contracts/rel/*` and expose domain semantics:

```
components/button/accent/primary/background -> contracts/rel/surface/accent/lighter/idle
components/button/accent/primary/label      -> contracts/rel/label/accent/base/idle
```

**Components** consume component tokens only — not raw relational paths.

---

## 5) Contrast Requirements (WCAG)

- **Text (normal):** ≥ 4.5:1 against background.
- **Text (≥ 18px regular or ≥ 14px bold):** ≥ 3.0:1.
- **Non-text UI (icons/graphics essential to understanding):** ≥ 3.0:1 recommended.
- When a chosen `Label/OnSurface` tone fails min contrast, select the nearest tone within the **same role** that passes. If none pass, use the role’s **inverse** label (as defined by the theme) and log an override.

**Recommended color space for deltas:** perceptual (e.g., OKLCH/OKLab). Avoid HSL/HSV for accessibility-sensitive deltas.

---

## 6) State Generation Rules (Deltas)

State values are computed from the base tone by applying **theme rules**. Example defaults (tune per theme):

```
hover:   ΔL +0.03 (light theme) / ΔL -0.03 (dark theme)
pressed: ΔL -0.04 (light theme) / ΔL +0.04 (dark theme)
disabled: α -0.50, ΔC -0.20, enforce min contrast with disabled text color
focus:   use stroke focus ring derived from role’s Stroke base (optionally +ΔC)
```

All states must be **deterministic** and computed by the tokens pipeline; avoid hand-entered overrides except for documented exceptions.

---

## 7) Fallbacks & Invariants

1. **Nearest tone fallback:** if an exact tone is missing, choose the nearest available tone in the same role.
2. **No cross-role mixing:** background, border, and foreground within a component must share the same role.
3. **Contrast fallback:** try `Label` tones in-role; if all fail, use `label.inverse` defined by the theme and record `meta.origin = "override"`.
4. **Transparency policy:** only surfaces may use alpha overlays per overlay rules; text colors must remain opaque for crisp rendering.

---

## 8) Lint Rules (Enforcement)

- **Path pattern:** any component token value must resolve to `^contracts/rel/(surface|stroke|onSurface|label|border)/(neutral|accent|positive|negative|warning)/[a-z0-9-]+/(idle|hover|pressed|focus|disabled)$`.
- **Ban raw hex in components.** Raw hex is permitted only in base palettes and generator inputs.
- **Contrast check:** CI verifies `foreground` vs `background` ratio per WCAG thresholds.
- **Origin metadata:** each token sets `meta.origin` to one of: `curated | generated | override`.
- **Coverage metric:** the build outputs `% generated vs curated` and lists overrides.

---

## 9) Authoring Workflow

1. Choose **role** for the component variant (e.g., `Accent.Primary`).
2. Map properties to **planes** using the contract table (Section 3).
3. Pick **tone** (`lighter/base/darker/...`) from the relational matrix.
4. States come **for free** via deltas.
5. CI validates contrast; Storybook renders the matrix and components for visual QA.

---

## 10) Examples

**Button (Accent.Primary)**

```
background: contracts/rel/surface/accent/lighter/idle
border:     contracts/rel/stroke/accent/lighter/idle
foreground: contracts/rel/label/accent/base/idle  (must pass contrast)
```

**Button (Neutral.Outline)**

```
background: contracts/rel/surface/neutral/darkest/idle (0α or transparent surface per theme)
border:     contracts/rel/stroke/neutral/darkest/idle
foreground: contracts/rel/label/neutral/base/idle
```

---

## 11) Extending the System

- **Add a role:** provide base palette entries; generate relational tones; run contrast tests.
- **Add a plane:** justify the plane’s purpose and define its contract mapping (what properties can use it).
- **Tune deltas:** edit `rules.json` (light & dark separately) and re-run the generator.

---

## 12) Exceptions Policy

Overrides are allowed only when a product requirement cannot be met with the current rules. Every override must:

- live in the product layer (never in `contracts/rel/*`),
- set `meta.origin = "override"` and a human-readable `meta.reason`,
- pass accessibility checks or carry an explicit waiver with sign-off.

---

## 13) Versioning

- Changes to roles/planes/tones/states or their contracts are **minor** if backward-compatible, **major** otherwise.
- The manifest is versioned alongside the tokens package; components consume a pinned version.

---

## 14) QA Checklist

- [ ] All semantic/component tokens resolve to allowed paths.
- [ ] Contrast CI passes for all component states in light & dark themes.
- [ ] Storybook renders the relational matrix for each theme.
- [ ] Coverage report ≥ target (e.g., ≥ 80% generated).
- [ ] No raw hex in components.
- [ ] Overrides labeled and documented.

---

## 15) Glossary

- **Relational matrix:** the curated/generative table of role × plane × tone × state values.
- **Plane:** conceptual color layer (surface/stroke/label/...).
- **Role:** semantic purpose of a color family (accent/positive/...).
- **Tone:** lightness/saturation step within a role’s palette.
- **Delta:** numeric rule to derive state/variations from a base tone.

---

## 16) Appendix: Reference Regex

```
^contracts/rel/(surface|stroke|onSurface|label|border)/(neutral|accent|positive|negative|warning)/([a-z0-9-]+)/((idle|hover|pressed|focus|disabled))$
```

> This manifest makes the relational color matrix self-documenting and enforceable. Follow the contracts, keep roles cohesive, and let deltas and contrast rules do the heavy lifting.
